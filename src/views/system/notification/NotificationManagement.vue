<template>
  <div>
    <v-row>
      <app-card :heading="'알림 관리'" col-classes="col-sm-12 col-md-6">
        <template>
          <v-row align="center" justify="center">
            <v-col class="pt-0"></v-col>
            <v-col class="pt-0">
              <v-text-field v-model="filter" hide-details outlined small dense append-icon="mdi-magnify" label="Search"/>
            </v-col>
          </v-row>
        </template>
        <template v-if="filteredList && filteredList.length > 0">
          <v-list dense>
            <draggable v-model="notiList">
              <transition-group type="transition" name="flip-list">
                <v-list-item
                  v-for="notify of filteredList"
                  :key="notify.sortSeq"
                  @click="viewChildren(notify)"
                  class="menu-list"
                  :class="notify.active? 'active' : ''"
                >
                  <v-list-item-action>
                    <v-icon>edit</v-icon>
                  </v-list-item-action>
                  <v-list-item-content>
                    <v-list-item-title :class="notify.useYn === 'N'? 'strike' : ''">{{ notify.notifyNm }} ({{ notify.notifyId }})</v-list-item-title>
                  </v-list-item-content>
                  <v-list-item-action>
                    <v-icon>keyboard_arrow_right</v-icon>
                  </v-list-item-action>
                </v-list-item>
              </transition-group>
            </draggable>
          </v-list>
        </template>
        <v-row v-else align="center" justify="center">알림 정보가 없습니다.</v-row>
        <v-divider class="my-4"></v-divider>
        <v-row align="end" justify="center">
          <v-btn outlined rounded small color="orange" @click="sort(notiList)" v-if="!filter">
            <v-icon small class="mr-1">refresh</v-icon>원래대로
          </v-btn>
          <v-btn outlined rounded small color="info" @click="sortChange(notiList)" v-if="!filter">
            <v-icon small class="mr-1">swap_vert</v-icon>순서 저장
          </v-btn>
          <v-btn outlined rounded small color="primary" @click="addNotify()">
            <v-icon small>add</v-icon>알림 메뉴 추가
          </v-btn>
        </v-row>
      </app-card>
      <app-card :heading="'상세 정보'" col-classes="col-sm-12 col-md-6">
        <v-row v-if="!detail.notifyId" align="center" justify="center">관리할 알림을 선택해 주세요.</v-row>
        <template v-else>
          <v-form ref="detail" lazy-validation>
            <v-label>알림 ID</v-label>
            <v-text-field
              v-model="detail.notifyId"
              :rules="emptyRules"
              label
              required
              class="pt-0"
              disabled
            ></v-text-field>
            <v-label>알림 구분</v-label>
            <v-autocomplete v-model="detail.notifyType" :rules="emptyRules" :items="serverCodeList" :item-text="'commCdNm'" :item-value="'commCd'" required class="pb-3 pt-0"/>
            <v-label>알림 이름</v-label>
            <v-text-field v-model="detail.notifyNm" :rules="emptyRules" label required class="pb-0"/>
            <v-label>
              알림 제목
              <common-tooltip :type="'info'" :position="'right'" :text="'{숫자}의 내용은 알림 전송 시, 알림 수신 테이블에 저장된 파라미터 1~5번까지의 내용으로 변경됩니다.'" />
            </v-label>
            <v-text-field v-model="detail.title" :rules="emptyRules" label required class="pt-0"/>
            <v-label>설명</v-label>
            <v-textarea
              auto-grow
              filled
              color="deep-purple"
              rows="1"
              v-model="detail.notifyDesc"
              label
              class="pt-0"
            ></v-textarea>
            <v-checkbox
              class="mt-0"
              v-model="detail.useYn"
              label="사용여부(미사용 시 알림은 발송되지 않습니다.)"
              required
              true-value="Y"
              false-value="N"
            ></v-checkbox>
          </v-form>
        </template>
        <v-divider v-if="detail.notifyId" class="my-4"></v-divider>
        <v-row align="end" justify="center" v-if="detail.notifyId">
          <v-btn outlined rounded small color="orange" @click="reload()">
            <v-icon small>refresh</v-icon>원래대로
          </v-btn>
          <v-btn outlined rounded small color="info" @click="modify()">
            <v-icon small>edit</v-icon>수정
          </v-btn>
        </v-row>
      </app-card>
    </v-row>

    <v-navigation-drawer fixed v-model="dialog" :width="600" right app stateless temporary>
      <v-toolbar dark color="primary">
        <v-btn icon dark @click="dialog = false">
          <v-icon>close</v-icon>
        </v-btn>
        <v-spacer></v-spacer>
        <v-toolbar-title>알림 메뉴 입력</v-toolbar-title>
        <v-spacer></v-spacer>
        <v-toolbar-items>
          <v-btn dark text @click="dialog = false">Close</v-btn>
        </v-toolbar-items>
      </v-toolbar>
      <v-container fluid>
        <v-form ref="form" lazy-validation>
          <v-label>알림 ID</v-label>
          <v-text-field v-model="form.notifyId" :rules="emptyRules" label disabled class="pt-0"></v-text-field>
          <v-label>알림 구분</v-label>
          <v-autocomplete v-model="form.notifyType" :rules="emptyRules" :items="serverCodeList" :item-text="'commCdNm'" :item-value="'commCd'" required class="pb-3 pt-0"/>
          <v-label>알림 이름</v-label>
          <v-text-field v-model="form.notifyNm" :rules="emptyRules" label required class="pt-0"></v-text-field>
          <v-label>
            알림 제목
            <common-tooltip :type="'info'" :position="'right'" :text="'{숫자}의 내용은 알림 전송 시, 알림 수신 테이블에 저장된 파라미터 1~5번까지의 내용으로 변경됩니다.'" />
          </v-label>
          <v-text-field v-model="form.title" :rules="emptyRules" label required class="pt-0"/>
          <v-label>설명</v-label>
          <v-textarea
            auto-grow
            filled
            color="deep-purple"
            rows="1"
            v-model="form.notifyDesc"
            label
            class="pt-0"
          ></v-textarea>
          <v-checkbox
            class="mt-0"
            v-model="form.useYn"
            label="사용여부(미사용 시 알림은 발송되지 않습니다.)"
            required
            true-value="Y"
            false-value="N"
          ></v-checkbox>

          <v-row justify="center">
            <v-btn outlined rounded small color="orange" @click="reset()">
              <v-icon small>refresh</v-icon>원래대로
            </v-btn>
            <v-btn outlined rounded small color="info" @click="insert()">
              <v-icon small>check</v-icon>입력
            </v-btn>
            <v-btn outlined rounded small color="primary" @click="dialog = false">
              <v-icon small>close</v-icon>닫기
            </v-btn>
          </v-row>
        </v-form>
      </v-container>
    </v-navigation-drawer>
  </div>
</template>

<script>
import notiManageService from 'Api/modules/system/notificationManagement.service'
import commonCodeService from 'Api/modules/system/commonCode.service'
import CommonTooltip from 'Components/Common/CommonTooltip.vue'

export default {
  name: 'notificationManagement',
  components: {
    CommonTooltip
  },
  data () {
    return {
      notiList: [],
      serverCodeList: [],
      detail: {},
      detailClone: {},
      dialog: false,
      form: {},
      filter: ''
    }
  },
  computed: {
    filteredList () {
      return this.notiList.filter(data => data.notifyNm.indexOf(this.filter) !== -1 || data.notifyId.indexOf(this.filter) !== -1)
    }
  },
  mounted () {
    // key press event match
    this.$store.dispatch('keypress/addKeyEventList', {
      eventList: [{ target: 'escape', action: this.close }]
    })
    this.search()
    this.getServerCode()
  },
  methods: {
    getServerCode () {
      commonCodeService.selectCommonCode('NOTIFY_TYPE').then(res => {
        this.serverCodeList = res.data
      })
    },
    getNewNotifyId () {
      notiManageService.newNotifyId().then(res => {
        this.$set(this.form, 'notifyId', res.data)
      })
    },
    search (notifyId) {
      notiManageService.selectList({}).then(res => {
        this.notiList = res.data
        if (notifyId) {
          for (const row of this.notiList) {
            if (row.notifyId === notifyId) {
              this.viewChildren(row)
            }
          }
        }
      })
    },
    viewChildren (notify) {
      for (const row of this.notiList) {
        row.active = row.notifyId === notify.notifyId
      }
      this.detail = _.cloneDeep(notify)
      this.detailClone = _.cloneDeep(notify)
    },
    reload () {
      this.detail = _.cloneDeep(this.detailClone)
    },
    addNotify () {
      this.form = { useYn: 'Y' }
      this.getNewNotifyId()
      this.dialog = !this.dialog
    },
    sortChange (list) {
      // 순서가 변환된 목록을 추려낸다.
      const changeList = []
      for (let index = 0; index < list.length; index++) {
        const seq = index + 1
        if (seq !== list[index].sortSeq) {
          changeList.push({ notifyId: list[index].notifyId, sortSeq: seq })
        }
      }
      if (changeList.length === 0) {
        this.$dialog.alert('변경된 사항이 없습니다.')
      } else {
        this.$dialog
          .confirm('순서를 변경하시겠습니까?')
          .then(() => {
            notiManageService.updateSort(changeList).then(res => {
              this.$dialog.alert('저장되었습니다.')
              this.search(this.detail.notifyId)
            })
          })
          .catch(() => {})
      }
    },
    modify () {
      this.validForm(this.$refs.detail).then(() => {
        this.$dialog
          .confirm('알림 메뉴를 수정하시겠습니까?')
          .then(() => {
            notiManageService.update(this.detail).then(res => {
              this.$dialog.alert('정보를 입력하였습니다.')
              this.search(this.detail.notifyId)
            })
          })
          .catch(() => {})
      })
    },
    insert () {
      this.validForm(this.$refs.form).then(() => {
        this.$dialog
          .confirm('알림 메뉴를 입력하시겠습니까?')
          .then(() => {
            notiManageService.insert(this.form).then(res => {
              this.$dialog.alert('정보를 입력하였습니다.')
              this.search(this.detail.notifyId)
              this.dialog = false
            })
          })
          .catch(() => {})
      })
    },
    reset () {
      this.form = {}
      this.$refs.form.resetValidation()
    },
    close () {
      this.dialog = false
    }
  }
}
</script>
